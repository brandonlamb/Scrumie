<?php

function prepareTask(Task $task, $project) {

    if($task->estimation === null)
        $task->estimation = 1;

    if($task->done === null)
        $task->done = 0;

    if($task->body === null)
        $task->body = 'Double click to edit...';

    $owner = array('<option>Select owner...</option>');
    foreach($project->users as $userProject) {
        $user = $userProject->user;
        $selected = ($task->owner == $user->login) ? 'selected="selected"' : '';
        $owner[] = "<option $selected value='{$user->login}'>{$user->login}</option>";
    }

    $taskHelper = '
        <div id="%s" class="task draggable">
            <div class="body" style="background-color: %s" ondblclick="Scrumie.Task.edit($(this).parent())" >%s</div>
            <div class="status">
                <input title="Estimation" onchange="Scrumie.Task.save($(this).parent().parent())" onkeyup="Scrumie.Task.changeProgress(event, this)" class="estimation noneditable" value="%s"/>
                <input onchange="Scrumie.Task.save($(this).parent().parent())" onkeyup="Scrumie.Task.changeProgress(event, this)" title="Done" class="done noneditable" value="%s"/>
                <select title="Owner" onchange="Scrumie.Task.save($(this).parent().parent())" name="owner" class="owner">%s</select>
                <img class="delete_task" onclick="Scrumie.Task.del($(this).parent().parent())" src="http://cdn1.iconfinder.com/data/icons/uidesignicons/delete.png" title="Delete task" />
                <span class="confirm_delete"> <em>Are you sure?:</em><button class="yes">Yes</button><button class="cancel">Cancel</button> </span>
                <button data-color="#F79F81" class="color red noneditable"></button><button data-color="lightgreen" class="color green noneditable"></button><button data-color="lightblue" class="color blue noneditable"></button><button data-color="#FFFECB" class="color yellow noneditable"></button><button data-color="#ddd" class="color gray noneditable"></button>
                <span style="display: inline-block; margin-right: 1px;">
            </div>
        </div>';

    return sprintf($taskHelper, $task->id, $task->color, $task->body, $task->estimation, $task->done, join('', $owner));
}


function prepareUserStory($story, $project) {
    $storyHtml = '
        <table class="user_story" data-storyid="%s">
        <tbody>
            <tr class="title">
                <td colspan="4">
                    <img class="move_to_backlog" onclick="Scrumie.Story.detach($(this).parent().parent().parent().parent())" title="'.( ($story->id_sprint) ? 'Move to backlog' : 'Move to sprint').'" src="http://cdn3.iconfinder.com/data/icons/woothemesiconset/16/arrow_left.png"/>
                    <img class="add_new_task" onclick="Scrumie.Task.add($(\'#newtask\').find(\'div.task\'), $(this).parent().parent().next(\'tr\').find(\'td.todo\'))" src="http://cdn2.iconfinder.com/data/icons/basicset/plus_16.png">
                    <img title="Delete user story" class="delete_user_story" onclick="Scrumie.Story.del($(this).parent().parent().parent().parent())" src="http://cdn2.iconfinder.com/data/icons/oxygen/16x16/actions/mail-delete.png"/>
                    <span class="user_story confirm_delete"> <em>Are you sure?:</em><button class="yes">Yes</button><button class="cancel">Cancel</button> </span>
                    <span class="name" ondblclick="Scrumie.Story.edit($(this).parent().parent().parent().parent())">%s</span>
                </td>
            </tr>
            <tr>
                <td data-state="todo" class="todo droppable">%s</td>
                <td data-state="inProgress" class="inProgress droppable">%s</td>
                <td data-state="toVerify" class="readyForTest droppable">%s</td>
                <td data-state="done" class="done droppable">%s</td>
            </tr>
            <tr><td colspan="4" style="height: 10px; border: 0;"></td></tr>
        </tbody>
        </table>
    ';

    if(count($story->getTasks())) {
        $todo = '';
        foreach($story->getTasks()->getTodo() as $task) {
            $todo .= prepareTask($task, $project);
        }

        $inProgress = '';
        foreach($story->getTasks()->getInProgress() as $task) {
            $inProgress .= prepareTask($task, $project);
        }

        $toVerify = '';
        foreach($story->getTasks()->getToVerify() as $task) {
            $toVerify .= prepareTask($task, $project);
        }

        $done = '';
        foreach($story->getTasks()->getDone() as $task) {
            $done .= prepareTask($task, $project);
        }
        return sprintf($storyHtml, $story->id, $story->name, $todo, $inProgress, $toVerify, $done);
    }
    else {
        return sprintf($storyHtml, $story->id, $story->name, null, null, null, null);
    }
}
?>
<?php if(isset($this->project)): ?>
    <div id="newtask" class="hidden">
        <?php echo prepareTask(new Task(), $this->project) ?>
    </div>
<?php endif ?>

<div id="tabs">
    <ul>
        <li><a href="#tabs-home"><img src="http://cdn1.iconfinder.com/data/icons/gnomeicontheme/16x16/actions/redhat-home.png"></a></li>
        <?php if(isset($this->sprint)): ?>
        <li><a href="#tabs-board"><?= $this->sprint->name; ?></a></li>
        <li><a href="#tabs-burndownchart">Burn down chart</a></li>
        <?php endif ?>
        <?php if(isset($this->project)): ?>
        <li><a href="#tabs-backlog">Backlog</a></li>
        <?php endif ?>
        <li><a onclick="Scrumie.logout()">Logout</a></li>
    </ul>

    <!-- HOME -->
    <div id="tabs-home" class="tabContent">
        <table class="home">
            <tr><th>Welcome!</th><td style="font-weight: bold; font-size: 18px;"><?= $this->user->login; ?>
            </td></tr>
            <tr>
                <th style="vertical-align: top">Projects:</th>
                <td>
                    <fieldset>
                        <legend>
                            <input id="new-project-name" type="text" placeholder="New project name">
                            <button title="Add new project" onclick="Scrumie.Project.add($('#new-project-name').val())">+</button>
                            <button title="Untouch/Delete project.&#13;Project will be deleted when no others contributors are assigned to it, otherwise it will be untouch only from your account" onclick="Scrumie.Project.del($('.projectName.selected'))">-</button>
                        </legend>
                        <div style="padding: 10px;">
                        <?php
                        $projects = array();
                        foreach($this->user->projects as $userProject) {
                            $project = $userProject->project;
                            $class = (isset($this->currentProjectId) && $project->id == $this->currentProjectId) ? 'selected' : '';
                            $projects[] = '<div data-projectId="'.$project->id.'" onclick="Scrumie.Project.select('.$project->id.')" class="projectName '.$class.'">'.$project->name.'</div>';
                        }
                        echo join('', $projects);
                        ?>
                        </div>
                    </fieldset>
                </td>
            </tr>

            <?php if(isset($this->project)): ?>
            <tr><th style="vertical-align: top;" >Spints:</th>
                <td style="padding: 0">
                    <fieldset>
                        <legend>
                            <input id="new-sprint-name" type="text" placeholder="sprint name">
                            <button title="Add new sprint" onclick="Scrumie.Sprint.add($(this).parent().find('input').val())">+</button>
                        </legend>
                        <ul id="sprints-list">
                            <?php
                            foreach($this->project->sprints as $sprint) {
                                $edit = '<span onclick="Scrumie.Sprint.edit('.$sprint->id.')" class="ui-icon ui-icon-pencil icon" title="Edit sprint name" ></span>';
                                $delete = '<span onclick="Scrumie.Sprint.del('.$sprint->id.')" class="ui-icon ui-icon-trash icon" title="Delete" ></span>';

                                echo "<li data-sprintId='{$sprint->id}' class='sprint'><span contenteditable='false' onclick='Scrumie.Sprint.select({$sprint->id});' class='href' style='padding: 2px; margin-right: 10px;'>{$sprint->name}</span>$edit&nbsp;$delete</li>";
                            }
                            ?>
                        </ul>
                    </fieldset>
                </td>
            </tr>

            <tr><th style="vertical-align: top;">Contributors:</th>
                <td style="padding: 0">
                    <fieldset class="contributors">
                        <legend>
                            <input id="new-contributor-name" type="text" placeholder="username">
                            <button title="Add new contributor" onclick="Scrumie.Project.addUser($('#new-contributor-name').val())">+</button>
                        </legend>
                        <blockquote>
                        <?php
                        $contributors = array();
                        foreach($this->project->users as $projectUser) {
                            $user = $projectUser->user;
                            if($user->email) {
                                $contributors[] = '<a href="mailto:'.$user->email.'">'.$user->login.'</a>';
                            } else {
                                $contributors[] = '<span>'.$user->login.'</span>';
                            }
                        }
                        echo join(', ', $contributors);
                        ?>
                        </blockquote>
                    </fieldset>
                </td>
            </tr>
            <?php endif ?>
        </table>
    </div>

    <!-- BACKLOG -->
    <?php if(isset($this->project)): ?>
    <div id="tabs-backlog" class="tabContent">
        <div class="sortable" id="detached">
        <?php
        foreach($this->project->getDetachedStories() as $story) {
            echo prepareUserStory($story, $project);
        }
        ?>
        </div>
        <button onclick="Scrumie.Backlog.Story.add($(this).next().find('table').clone());">Add new User Story</button>
        <div id="newuserstory" class="hidden">
            <?= prepareUserStory(new Story(), $project) ?>
        </div>
    </div>
    <?php endif ?>


    <!-- SPRINT -->
    <?php if(isset($this->sprint)): ?>
    <div id="tabs-board" class="tabContent">
        <div id="story-container">
            <table class="user_story header">
            <tr>
                <th>TODO</th>
                <th>IN PROGRESS</th>
                <th>TO VERIFY</th>
                <th>DONE</th>
            </tr>
            </table>
            <?php foreach($this->sprint->getStories() as $story): ?>
                <?= prepareUserStory($story, $project) ?>
            <?php endforeach ?>
        </div>
        <button onclick="Scrumie.Story.add($(this).next().find('table').clone());">Add new User Story</button>
        <div id="newuserstory" class="hidden">
            <?= prepareUserStory(new Story(), $project) ?>
        </div>
    </div>
    <?php endif ?>

    <!-- BURN DOWN CHART -->
    <?php if(isset($this->sprint)): ?>
    <div id="tabs-burndownchart" class="tabContent">
    <button onclick="reloadBtc()">Redraw</button>
    <div style="width: 90%" id="burndownchart-container"></div>
    <script>
        var chart;
        $(document).ready(function() {
           chart = new Highcharts.Chart({
              chart: {
                 renderTo: 'burndownchart-container'
              },
              xAxis: {
                categories: [<?= '"'.join('","', $this->sprint->tasks->getAllTasksUpdateDates('D/d/M')).'"'; ?>]
              },
              yAxis: {
                 title: {text: 'Estimation points'},
                 min: 0,
                 max: <?= $this->sprint->tasks->getEstimationSum() ?>,
              },
              title: {
                 text: 'Burndown chart'
              },
              tooltip: { formatter: function() { return this.y +' points' } },
              series: [{
                 name: 'Points left',
                 data: [<?= join(",", $this->sprint->getEstimationForEachSprintDate()) ?>],
                 marker: {
                    radius: 4
                 }
              }]
           });
        });

        function reloadBtc() {
            location.href = location.href.replace(/&tab.*/, '') + '&tab=2';
        }
    </script>
    </div>
    <?php endif ?>

</div>

<script>

function updateSummary() {
    var summary = [];
    summary['todo'] = {all: 0, done: 0};
    summary['inProgress'] = {all: 0, done: 0};
    summary['commited'] = {all: 0, done: 0};
    summary['readyForTest'] = {all: 0, done: 0};
    summary['done'] = {all: 0, done: 0};

    $.each($('table#board td.dropable'), function(index,element) {
        var column = $(element).attr('id');

        var summaryEstimation = 0;
        $.each($(element).children('div.task').children('span.estimation'), function(i, e) {
            summaryEstimation += getAsNumber($(e).html());
        });

        var summaryDone = 0;
        $.each($(element).children('div.task').children('span.done'), function(i, e) {
            summaryDone += getAsNumber($(e).html());
        });

        summary[column].all = summaryEstimation;
        summary[column].done = summaryDone;

    });

    $('span#todo-sum-estimation').html(summary['todo'].all);
    $('span#todo-sum-done').html(summary['todo'].done);

    $('span#inProgress-sum-estimation').html(summary['todo'].all + summary['inProgress'].all);
    $('span#inProgress-sum-done').html(summary['inProgress'].done);
    
    $('span#commited-sum-estimation').html(summary['todo'].all + summary['inProgress'].all + summary['commited'].all);
    $('span#commited-sum-done').html(summary['commited'].done);

    $('span#readyForTest-sum-estimation').html(summary['todo'].all + summary['inProgress'].all + summary['commited'].all + summary['readyForTest'].all);
    $('span#readyForTest-sum-done').html(summary['readyForTest'].done);

    $('span#done-sum-estimation').html(summary['todo'].all + summary['inProgress'].all + summary['commited'].all + summary['readyForTest'].all + summary['done'].all);
    $('span#done-sum-done').html(summary['done'].done);
}
</script>
