<?php
function prepareTask(Task $task, $draggable = true) {

    if($task->estimation === null)
        $task->estimation = 1;

    if($task->done === null)
        $task->done = 0;

    $draggable = ($draggable) ? 'draggable' : '';

    $taskHelper = '
        <div id="%s" class="task round4 %s">
            <div class="editable body">%s</div>
            <span title="Estimation" class="estimation">%s</span>
            &nbsp;
            <span title="Done" class="done">%s</span>
            &nbsp;
            <span class="owner" title="Owner" style="float: right;">%s</span>
        </div>';

    return sprintf($taskHelper, $task->id, $draggable, $task->body, $task->estimation, $task->done, $task->owner);
}

?>

<style>
.sprint .icon {border: 1px solid #ddf; position: relative; top: 2px; display: inline-block; cursor: pointer;}
div#tabs ul li {height: 28px;}
table.home td {border: 0;}
table.home th {width: 100px; text-align: right;}
fieldset {
    margin-bottom: 20px; 
    border: 0px solid #ddd; 
    border-top: 1px solid #999; 
    border-left: 0; 
    border-bottom: 0; 
    padding: 0;
    border-radius: 5px;
    background-image: -webkit-gradient(
        linear,
        left bottom,
        left top,
        color-stop(0.20, rgb(252,252,252)),
        color-stop(0.72, rgb(240,240,240))
    );

}
fieldset legend {
    border-radius: 5px;
    border: 1px solid lightgray;
    background: #eee;
}

.projectName {margin-left: 5px; display: inline-block; padding: 5px; padding-left: 20px; padding-right: 20px; background: #eee; border-radius: 5px; cursor: pointer;}
.projectName:hover {background: lightgreen}
.selected {background: lightgreen}
.href {cursor: pointer;}
.href:hover {text-decoration: underline;}
</style>

<div id="tabs">
    <ul>
        <li><a href="#tabs-home"><img src="http://cdn1.iconfinder.com/data/icons/gnomeicontheme/16x16/actions/redhat-home.png"></a></li>
        <?php if(isset($this->sprint)): ?>
        <li><a href="#tabs-board"><?= $this->sprint->name; ?></a></li>
        <li><a href="#tabs-burndownchart">Burn down chart</a></li>
        <?php endif ?>
        <?php if(isset($this->project)): ?>
        <li><a href="#tabs-backlog">Backlog</a></li>
        <?php endif ?>
        <li><a onclick="location.href = uri('User', 'logout');">Logout</a></li>
    </ul>

    <div id="tabs-home" class="tabContent">
        <table class="home">
            <tr><th>Welcome!</th><td style="font-weight: bold; font-size: 18px;"><?= $this->user->login; ?>
            <input class="hidden" placeholder="dblclick to enter your email" id="userEmail" value="<?= $this->user->email; ?>" name="email" type="text" readonly title="double click to edit" ondblclick="$(this).attr('readonly', false)" onchange="emailChange()" onblur="$(this).attr('readonly', true);" style="margin-left: 20px; width: 300px; border:0; padding: 0;">
            </td></tr>
            <tr>
                <th style="vertical-align: top">Projects:</th>
                <td>
                    <fieldset>
                        <legend>
                            <button title="Add new project" onclick="addNewProject()">+</button>
                            <input id="new-project-name" type="text" placeholder="project name">
                            <div id="importProject" title="If you already have some projects in Scrumie, you can import it easly to your account. Just enter project name and its password" style="display: inline-block; padding: 5px;  border-radius: 4px; margin-left: 10px;">
                                Import:
                                <input placeholder="Project name" name="project" type="text">
                                <input placeholder="Project password" name="password" type="password">
                                <button style="margin-right: 10px;" onclick="importProject()">Import project</button>
                            </div>
                        </legend>
                        <blockquote>
                        <?php
                        $projects = array();
                        foreach($this->user->projects as $userProject) {
                            $project = $userProject->project;
                            $class = (isset($this->currentProjectId) && $project->id == $this->currentProjectId) ? 'selected' : '';
                            $projects[] = '<div onclick="selectProject(this);" class="projectName '.$class.'" data-projectId="'.$project->id.'">'.$project->name.'</div>';
                        }
                        echo join('', $projects);
                        ?>
                        </blockquote>
                    </fieldset>
                </td>
            </tr>

            <?php if(isset($this->project)): ?>
            <tr><th style="vertical-align: top;">Contributors:</th>
                <td style="padding: 0">
                    <fieldset class="contributors">
                        <legend>
                        <button title="Add new contributor" onclick="addNewUser()">+</button>
                        <input id="new-contributor-name" type="text" placeholder="username">
                        </legend>
                        <blockquote>
                        <?php
                        $contributors = array();
                        foreach($this->project->users as $projectUser) {
                            $user = $projectUser->user;
                            if($user->email) {
                                $contributors[] = '<a href="mailto:'.$user->email.'">'.$user->login.'</a>';
                            } else {
                                $contributors[] = '<span>'.$user->login.'</span>';
                            }
                        }
                        echo join(', ', $contributors);
                        ?>
                        </blockquote>
                    </fieldset>
                </td>
            </tr>
            <tr><th style="vertical-align: top;" >Spints:</th>
                <td style="padding: 0">
                    <fieldset>
                        <legend>
                            <button title="Add new sprint" onclick="addNewSprint()">+</button>
                            <input id="new-sprint-name" type="text" placeholder="sprint name">
                        </legend>
                        <ul id="sprints-list">
                            <?php
                            foreach($this->project->sprints as $sprint) {
                                $edit = '<span onclick="editSprint(this)" class="ui-icon ui-icon-pencil round4 icon" title="Edit sprint name" ></span>';
                                $delete = '<span onclick="deleteSprint(this)" class="ui-icon ui-icon-trash round4 icon" title="Delete" ></span>';
                                echo "<li data-sprintId='{$sprint->id}' class='sprint'><span class='href' style='padding: 2px; margin-right: 10px;' onclick='selectSprint($sprint->id)'>{$sprint->name}</span>$edit&nbsp;$delete</li>";
                            }
                            ?>
                        </ul>
                    </fieldset>
                </td>
            </tr>
            <?php endif ?>
        </table>
    </div>

    <?php if(isset($this->sprint)): ?>
    <div id="tabs-board" class="tabContent">
        <div class="helpers">
            <button onclick="addNewTask();">+ Add new task</button>
        </div>
        <table id="board" class="round4">
            <tr>
                <th>
                    TODO
                    <div class="summary">
                        <span id="todo-sum-done">0</span>
                        /
                        <span id="todo-sum-estimation">0</span>
                    </div>
                </th>
                <th>
                    IN PROGRESS
                    <div class="summary">
                        <span id="inProgress-sum-done">0</span>
                        /
                        <span id="inProgress-sum-estimation">0</span>
                    </div>
                </th>
                <th>
                    COMMITED
                    <div class="summary">
                        <span id="commited-sum-done">0</span>
                        /
                        <span id="commited-sum-estimation">0</span>
                    </div>
                </th>
                <th>
                    READY FOR TEST
                    <div class="summary">
                        <span id="readyForTest-sum-done">0</span>
                        /
                        <span id="readyForTest-sum-estimation">0</span>
                    </div>
                </th>
                <th>
                    DONE
                    <div class="summary">
                        <span id="done-sum-done">0</span>
                        /
                        <span id="done-sum-estimation">0</span>
                    </div>
                </th>
            </tr>
            <tr>
                <td id="todo" class="droppable">
                <?php
                    foreach($this->sprint->tasks->getTodo() as $task) {
                        echo prepareTask($task);
                    }
                ?>
                </td>
                <td id="inProgress" class="droppable">
                <?php
                    foreach($this->sprint->tasks->getInProgress() as $task) {
                        echo prepareTask($task);
                    }
                ?>
                </td>
                <td id="commited" class="droppable">
                <?php
                    foreach($this->sprint->tasks->getCommited() as $task) {
                        echo prepareTask($task);
                    }
                ?>
                </td>
                <td id="readyForTest" class="droppable">
                <?php
                    foreach($this->sprint->tasks->getReadyForTest() as $task) {
                        echo prepareTask($task);
                    }
                ?>
                </td>
                <td id="done" class="droppable">
                <?php
                    foreach($this->sprint->tasks->getDone() as $task) {
                        echo prepareTask($task);
                    }
                ?>
                </td>
            </tr>
        </table>
    </div>
    <?php endif ?>

    <?php if(isset($this->sprint)): ?>
    <div id="tabs-burndownchart" class="tabContent">
    <button onclick="reloadBtc()">Redraw</button>
    <div style="width: 90%" id="burndownchart-container"></div>
    <script>
        var chart;
        $(document).ready(function() {
           chart = new Highcharts.Chart({
              chart: {
                 renderTo: 'burndownchart-container'
              },
              xAxis: {
                categories: [<?= '"'.join('","', $this->sprint->tasks->getAllTasksUpdateDates('D/d/M')).'"'; ?>]
              },
              yAxis: {
                 title: {text: 'Estimation points'},
                 min: 0,
                 max: <?= $this->sprint->tasks->getEstimationSum() ?>,
              },
              title: {
                 text: 'Burndown chart'
              },
              tooltip: { formatter: function() { return this.y +' points' } },
              series: [{
                 name: 'Points left',
                 data: [<?= join(",", $this->sprint->getEstimationForEachSprintDate()) ?>],
                 marker: {
                    radius: 4
                 }
              }]
           });
        });

        function reloadBtc() {
            location.href = location.href.replace(/&tab.*/, '') + '&tab=2';
        }
    </script>
    </div>
    <?php endif ?>

    <?php if(isset($this->project)): ?>
    <div id="tabs-backlog" class="tabContent">
        <button onclick="addNewBacklogTask();">+ Add new task</button>
        <div class="sortable" id="detached">
            <?php
                 foreach($this->project->tasks->getDetached() as $task) {
                    echo prepareTask($task, false);
                }
            ?>
        </div>
    </div>
    <?php endif ?>

</div>

<!-- task context menu -->
<div class="contextMenu" id="taskMenu">
    <ul>
        <li id="task_estimate">Estimate</li>
        <li id="task_done">Set done</li>
        <li id="task_setOwner">Set owner</li>
        <li><hr/></li>
        <li id="task_attach">Move to sprint</li>
        <li id="task_detach">Move&nbsp;to&nbsp;backlog</li>
        <li><hr/></li>
        <li id="task_delete">Delete</li>
    </ul>
</div>

<script>
function setDraggable() {
    $(".draggable").draggable({
        stop: function(event, ui) {
            $(this).css('top', 0);
            $(this).css('left', 0);
        }
    });

    $(".draggable").css('cursor', 'move');
}

function setSortable() {
    $(".sortable").sortable({
        stop: function() {
            var order = new Array;
            $.each($(this).children('div.task'), function(index, element) {
                order[index] = $(element).attr('id');
            });

            $.post(uri('Project','reorderTask'), {'order': order}, function(data, status, Request) {
            });
        }
    });
}

function setEditable() {

    $.each($('.editable'), function(index, element) {
        $(element).unbind();
    });

    $('.task').contextMenu("taskMenu", {
        shadow: true, 
        menuStyle: {
            width: '150px'
        },
        onShowMenu: function(e, menu) {
            var parent = $(e.currentTarget).parent();
            if($(parent).attr('id') == 'detached') {
                $('#task_detach', menu).remove();
            }
            else {
                $('#task_attach', menu).remove();
            }

            return menu;
        },
        bindings: {
            'task_estimate': function(t) {
                var value = prompt('Please enter estimation value');

                if(value === null)
                    return;

                if( value.match(/[^0-9]+/) )
                    alert('Estimation must be number');
                else
                    $(t).children('span.estimation').html(value);

                saveTask(t);
            },
            'task_done': function(t) {
                var value = prompt('Please enter value');

                if(value === null)
                    return;

                if( value.match(/[^0-9]+/) )
                    alert('It must be number');
                else
                    $(t).children('span.done').html(value);

                saveTask(t);
            },
            'task_setOwner': function(t) {
                var value = prompt('Please enter onwer');

                if(value === null)
                    return;

                $(t).children('span.owner').html(value);

                saveTask(t);
            },
            'task_delete': function(t) {
                if (! confirm('Are you sure you want to delete this task') )
                    return;

                $.post(uri('Project','deleteTask'), {taskId: $(t).attr('id')}, function(data, status, Request) {
                        if(data)
                            $(t).remove();
                });
            },
            'task_attach': function(t) {
                var task = $(t).appendTo('td#todo');
                saveTask(task);
            },
            'task_detach': function(t) {
                var task = $(t).appendTo('div#detached');
                saveTask(task);
            },
        }
    });

    $.each($('.editable'), function(index, element) {
        $(element).dblclick(function() {
            $(this).parent().draggable('option', 'disabled', true);
            $(this).attr('contenteditable', true);
            $(this).parent().fadeTo('slow', 0.9);
            $(this).css('border', '2px solid red');
            $(this).focus();

            $(this).unbind('blur');
            $(this).unbind('focus');
            $(this).blur(function () {
                saveTask($(this).parent());
            });
            $(this).focus(function () {
                //edit
            });
        });
    });
}

function saveTask(task) {
    $(task).draggable('option', 'disabled', false);
    $(task).fadeTo('slow', 1);
    var content = $(task).children('div.editable');
    $(content).attr('contenteditable', false);
    $(content).css('border', '0');

    var params = {
        taskId: $(task).attr('id'),
        body: $(content).html(),
        estimation: $(task).children('span.estimation').html(),
        done: $(task).children('span.done').html(),
        owner: $(task).children('span.owner').html(),
        sprintId: $(task).attr('data-sprintId'),
        state: $(task).parent().attr('id')
    };

    $.post(uri('Project', 'saveTask'), params, function(data, status, Request) {
        if(data)
            $(task).attr('id', data)
        else
            alert('Problem with saving data');
    });

    updateSummary();
}

function addNewTask() {
    var taskHtml = '<div id="" data-sprintId="<?= (isset($this->sprint)) ? $this->sprint->id : '';?>" class="task round4 draggable"><div class="editable body">Double click to edit...</div><span title="Estimation" class="estimation">1</span>&nbsp;<span class="done">0</span>&nbsp;<span class="owner" title="Owner" style="float: right;"></span></div>';
    var task = $(taskHtml).appendTo('td#todo');
    setEditable();
    setDraggable();
}

function addNewBacklogTask() {
    <?php
        $task = new Task;
        $task->estimation = 1;
        $task->done = 0;
        $task->body = 'Double click to edit...';
        $task->id = null;
        $task->owner = null;
    ?>
    var task = '<?= str_replace("\n", '' ,prepareTask($task, false)); ?>';
    $('#detached').append(task);
    setSortable();
    setEditable();
}

function emailChange() {
    var email = $('input#userEmail').val();
    $.post(uri('User', 'changeEmail'), {email: email}, function(data) {
    });
}

function deleteSprint(element) {
    var sprintId = $(element).parent().attr('data-sprintId');
    var name = $(element).parent().children('a').html();
    if (!confirm('Are you sure you want to delete "' + name + '"?\n\nAll information connected with this sprint will be permamently removed!'))
        return;

    $.post(uri('Project', 'deleteSprint'), {id: sprintId}, function(data) {
        if(data == true) {
            $(element).parent().remove();
        }
    })
}

function editSprint(element) {
    var sprintId = $(element).parent().attr('data-sprintId');
    var name = $(element).parent().children('a');
    $(name).attr('contenteditable', true);
    $(name).focus();
    $(name).blur(function() {
        $(this).attr('contenteditable', false);
        $(this).css('border', '0');
        $.post(uri('Project', 'renameSprint'), {id: sprintId, name: $(this).html()});
        $(this).unbind('blur');
    });
}

function addNewSprint() {
    var name = prompt('Sprint name');

    if(name == null)
        return

    if(name == '') {
        alert('Sprint name can\'t be empty');
        addNewSprint();
    }
    else {
        $.post(uri('Project','addNewSprint'), {'name': name}, function(data, status, Request) {
            if(data === true)
                window.location.reload();
            else
                alert(data.error);
        });
    }
}

function addNewProject() {
    var name = prompt('Project name');

    if(name == null)
        return

    if(name == '') {
        alert('Project name can\'t be empty');
        addNewProject();
    }
    else {
        $.post(uri('Project', 'addProject'), {'name': name}, function(data, status, Request) {
            if(data === true) {
                window.location.reload();
            } else {
                alert(data.error);
            }
        });
    }
}

$(".droppable").droppable({
    drop: function(event,ui) {
        ui.helper.appendTo(this);
        setDraggable();
        saveTask(ui.helper);
    }
});

function updateSummary() {
    var summary = [];
    summary['todo'] = {all: 0, done: 0};
    summary['inProgress'] = {all: 0, done: 0};
    summary['commited'] = {all: 0, done: 0};
    summary['readyForTest'] = {all: 0, done: 0};
    summary['done'] = {all: 0, done: 0};

    $.each($('table#board td'), function(index,element) {
        var column = $(element).attr('id');

        var summaryEstimation = 0;
        $.each($(element).children('div.task').children('span.estimation'), function(i, e) {
            summaryEstimation += getAsNumber($(e).html());
        });

        var summaryDone = 0;
        $.each($(element).children('div.task').children('span.done'), function(i, e) {
            summaryDone += getAsNumber($(e).html());
        });

        summary[column].all = summaryEstimation;
        summary[column].done = summaryDone;

    });

    $('span#todo-sum-estimation').html(summary['todo'].all);
    $('span#todo-sum-done').html(summary['todo'].done);

    $('span#inProgress-sum-estimation').html(summary['todo'].all + summary['inProgress'].all);
    $('span#inProgress-sum-done').html(summary['inProgress'].done);
    
    $('span#commited-sum-estimation').html(summary['todo'].all + summary['inProgress'].all + summary['commited'].all);
    $('span#commited-sum-done').html(summary['commited'].done);

    $('span#readyForTest-sum-estimation').html(summary['todo'].all + summary['inProgress'].all + summary['commited'].all + summary['readyForTest'].all);
    $('span#readyForTest-sum-done').html(summary['readyForTest'].done);

    $('span#done-sum-estimation').html(summary['todo'].all + summary['inProgress'].all + summary['commited'].all + summary['readyForTest'].all + summary['done'].all);
    $('span#done-sum-done').html(summary['done'].done);
}

function selectProject(el) {
    var projectId = $(el).attr('data-projectId');
    location.href = uri('Board', 'project') + '&id=' + projectId;
}

function selectSprint(id) {
    location.href = uri('Board', 'sprint') + '&id=' + id + '&tab=1';
}

function addNewUser() {
    $.post(uri('Project','addUserToProject'), {
        username: $('#new-contributor-name').val()
    }, function(data, status, Request) {
        if(data === true) {
            window.location.href = uri('Board', 'project');
        } else {
            alert(data.error);
        }
    });
}

function importProject() {
    $.post(uri('Project','import'), {
        project: $('#importProject input[name=project]').val(), 
        password: $('#importProject input[name=password]').val()
    }, function(data, status, Request) {
        if(data === true) {
            window.location.href = uri('Board', 'project');
        } else {
            alert(data.error);
        }
    });
}

$(function() {
    $( "#tabs" ).tabs();

    var tabIndex = parseInt($.getUrlVar('tab'));
    if(tabIndex)
        $( "#tabs" ).tabs({ selected: parseInt(tabIndex) });
    else if($.getUrlVar('sprint')) 
        $( "#tabs" ).tabs({ selected: 1 });

    setDraggable();
    setEditable();
    setSortable();
    $("table#board").css('height', ($(window).height() - 120));

    updateSummary();
});

</script>
